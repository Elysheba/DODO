---
title: "Testing"
author: "Liesbeth Fran√ßois"
date: "2/26/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(neoDODO)
```


```{r cars}
#from = ["HP:0002516", "ORPHA:637", "MeSH:D016518", "HP:0010628", "ORPHA:637", "MeSH:D016518"]
ids <- c("HP:0002516", "ORPHA:637", "MeSH:D016518", "HP:0010628", "ORPHA:637", "MeSH:D016518", "EFO:0008514")
ids <- c("HP:0002516", "ORPHA:637", "MeSH:D016518", "HP:0010628", "ORPHA:637", "MeSH:D016518")
ids <- c("MONDO:0005027", "EFO:0000474")
ids <- c("HP:0002516", "ORPHA:637")
ids <- findTerm("epilep")    
```

# Testing different buildDisNet functions (done, functions removed)

- standard buildDisNet
- performing multi query buildDisNet (buildMultiDisNet)
- performing graph query buildDisNet (buildGraphDisNet)

```{r}
ids <- c("MONDO:0005027", "EFO:0000474")
length(ids)

system.time(a <- build_disNet(ids = ids))
a

system.time(b <- extend_disNet(disNet = a, relations = c("xref", "child")))
b
## 3.820
# The disNet contains:
#  -  2186 disease nodes from 11 ontologies and 0 phenotype nodes from 0 ontologies 
#  -  8739 synonyms of the disease nodes
#  -  1951 parent/child edges
#  -  1761 crossreference edges
#  -  0 phenotype edges
#  -  The disNet was build based on 2 seeds

system.time(d <- extend_disNet(disNet = a, relations = c("xref", "child", "pheno")))
d
## 10.390s
# The disNet contains:
#  -  5245 disease nodes from 27 ontologies and 2530 phenotype nodes from 1 ontologies 
#  -  15016 synonyms of the disease nodes
#  -  1951 parent/child edges
#  -  7966 crossreference edges
#  -  19847 phenotype edges
#  -  The disNet was build based on 2 seeds

ids <- find_term("epilep")    
length(ids)
system.time(e <- convert_concept(from = ids, from.concept = "Disease", to.concept = "Phenotype"))
e
## 11.123s
## 60,860 rows

```

# Comparing efficiency Neo4j 3.5 vs 4.0

Bigger queries seem less efficient in the return of results. To compare with Neo4j 3.5 and 4.0 we get all identifiers in the EFO database and subsequently return all their synonyms and record the time.

This queries takes 49s in version 4.0 while it only takes 2.6s in version 3.5 (20 times faster).

```{r, results=T}
## Obtain all EFO identifiers and there synonyms

## Directly in Neo4j interface

# MATCH (n:Concept)-[:is_in]->(:Database {name:"EFO"}) 
# with collect(n) as node
# MATCH (n:Concept)-[:is_known_as]->(s:Synonym) WHERE n in node
# RETURN DISTINCT n.name AS id, s.value as syn

## --> for displaying 1000 rows = 76ms


######################################################################@
## Get all identifiers in EFO database
## Return their synonyms

######################################################################@
## Version 3.5
connect_to_dodo(url = "http://localhost:7476")
## R interface
cql <- c(
       'MATCH (n:Concept)-[:is_in]->(:Database {name:$database})',
       'RETURN DISTINCT n.name AS id, n.label AS label, n.definition AS definition, ',
                    'n.shortID AS shortID, n.level AS level, labels(n) AS type')
system.time(concepts <- call_dodo(
       neo2R::cypher,
       prepCql(cql),
       parameters=list(database="EFO"),
       result="row"
))
## 0.800s
ids = concepts$id
length(ids) ## 12,165 ids
cql.syn <- c('MATCH (n:Concept)-[r:is_known_as]-(s:Synonym)',
             'WHERE n.name IN $from',
             'RETURN DISTINCT n.name AS id, s.value AS synonym')
system.time(toRet <- call_dodo(cypher, 
                      prepCql(cql.syn), 
                      parameters = list(from = as.list(ids)), 
                      result = "row"))
dim(toRet) ## 84,955 rows
## 2.66s
rm(concepts, toRet)

######################################################################@
## Version 4
connect_to_dodo(url = "http://localhost:7475")
## R interface
cql <- c(
       'MATCH (n:Concept)-[:is_in]->(:Database {name:$database})',
       'RETURN DISTINCT n.name AS id, n.label AS label, n.definition AS definition, ',
                    'n.shortID AS shortID, n.level AS level, labels(n) AS type')
system.time(concepts <- call_dodo(
       neo2R::cypher,
       prepCql(cql),
       parameters=list(database="EFO"),
       result="row"
))
## 1.8
ids = concepts$id
length(ids) ## 12165
cql.syn <- c('MATCH (n:Concept)-[r:is_known_as]-(s:Synonym)',
             'WHERE n.name IN $from',
             'RETURN DISTINCT n.name AS id, s.value AS synonym')
system.time(toRet <- call_dodo(cypher, 
                      prepCql(cql.syn), 
                      parameters = list(from = as.list(ids)), 
                      result = "row"))

dim(toRet) ## 84,955 rows
## 49s

```